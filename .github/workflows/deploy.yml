name: Deploy Production from Template

on:
  push:
    branches:
      - master
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Prepare AppSettings
        run: |
          cp WebAPI/appsettings.Template.json appsettings.Production.json
          sed -i '/^[[:blank:]]*\/\//d' appsettings.Production.json
          sed -i 's|[[:blank:]]\+//.*||g' appsettings.Production.json

      - name: Inject Secrets
        uses: microsoft/variable-substitution@v1
        with:
          files: "appsettings.Production.json"
        env:
          AllowedHosts: ${{ secrets.ALLOWED_HOSTS }}
          ConnectionStrings.StringConnection: ${{ secrets.DB_CONNECTION }}
          Jwt.Key: ${{ secrets.JWT_KEY }}
          Jwt.Issuer: ${{ secrets.JWT_ISSUER }}
          Jwt.Audience: ${{ secrets.JWT_AUDIENCE }}
          ProtectedAuthorizationEntities.SuperRoles: ${{ secrets.SUPER_ROLES }}
          ProtectedAuthorizationEntities.ProtectedUsers: ${{ secrets.PROTECTED_USERS }}
          ProtectedAuthorizationEntities.DefaultRolesForNewUsers: ${{ secrets.DEFAULT_ROLES }}
          SeedingOptions.RunDataSeedingOnStartup: ${{ secrets.RUN_DATA_SEEDING }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Install EF Core Tools
        run: dotnet tool install --global dotnet-ef

      - name: Generate MySQL Migration Script
        run: |
          cd Infrastructure
          dotnet ef migrations script --context MySqlDbContext --output ../mysql_schema.sql
          cd ..
        continue-on-error: true

      - name: Publish
        run: dotnet publish --configuration Release --no-build --output ./publish

      - name: Move AppSettings to Publish Folder
        run: cp appsettings.Production.json ./publish/

      - name: Move Migration Script to Publish Folder (if exists)
        run: |
          if [ -f mysql_schema.sql ]; then
            cp mysql_schema.sql ./publish/
          fi
        continue-on-error: true

      - name: Clean Remote Directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            rm -rf /home/anhemmot/projects/anhemmotor-backend/*

      - name: Copy Files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "./publish/*"
          target: "/home/anhemmot/projects/anhemmotor-backend"
          strip_components: 1

      - name: Execute Remote SSH Commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Run database migration if script exists
            if [ -f /home/anhemmot/projects/anhemmotor-backend/mysql_schema.sql ]; then
              echo "Running database migration..."
              mysql -u ${{ secrets.DB_USER }} -p${{ secrets.DB_PASSWORD }} ${{ secrets.DB_NAME }} < /home/anhemmot/projects/anhemmotor-backend/mysql_schema.sql
              echo "Migration completed successfully"
            else
              echo "No migration script found, skipping..."
            fi
            
            # Restart application
            sed -i 's/\r$//' /home/anhemmot/scripts/restart_app.sh
            chmod +x /home/anhemmot/scripts/restart_app.sh
            bash /home/anhemmot/scripts/restart_app.sh
